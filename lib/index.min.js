!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Mem=e():t.Mem=e()}(global,function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=5)}([function(t,e){t.exports=require("lodash")},function(t,e,r){"use strict";var n,i,s,o,a,u,l,c,h,f,p,d,m,y,g,_;m=r(0),s=r(3),p={},u={},c={},f={},o={},n=[],i=0,h=function(){return Object.create(null)},l=class{static bless(t){return Reflect.setPrototypeOf(t,this.prototype),t.write_at=0,t.depth=0,null==t.pack&&(t.pack=h()),t}json(){return JSON.stringify(this,(t,e)=>{var r,n;return e&&e.meta&&e.item&&e.$group&&e.meta===this?(({item:n,$group:r}=e),{item:n,$group:r}):e})}},a=function(t={}){return l.bless(t),t},_=function(){return++i},d={transaction:function(t,e){var r;return this.$journal=r=a(e),r.depth++&&console.warn("nested transaction"),t(r),r.depth--,this.$journal=a(),r},journal:(y=function(t){return function(e){var r,n;return(r=d[t].pack)[e]?r[e]:((n=r[e]=h()).$sort=h(),n.$memory=h(),n.$format=h(),n)}})("$journal"),base:y("$base"),meta:function(){return this.$journal},step:h(),$journal:a(),$base:a(),store:function(t){var e,r,n,i,a,u,l,c,h,f,d,m;if(!(null!=t?t.pack:void 0))return!1;for(c in d=t.pack)if(({$sort:n,$memory:r,$format:e}=d[c]),m=p[(a=o[c]).$name.base],a&&m){for(l in({model:h}=m),i=this.base(c),u=this.journal(c),n)f=n[l],i.$sort[l]=f,u.$sort[l]=f;for(l in e)f=e[l],i.$format[l]=f,u.$format[l]=f;for(l in r)f=r[l],s.bless(f,t,h),i.$memory[l]=f,u.$memory[l]=f;m.clear_cache()}else console.error("not found Finder and Query",c,t.pack);return!0},mixin:{data:function(){return{$step:d.step}}},join:function({react:t}){t&&n.push(t)},bye:function({react:t}){t&&(n=n.filter(function(e){return e!==t}))},notify:function(t){if(this.step[t]=_(),n.length)return this.notify_for_react()},notify_for_react:m.debounce(function(){var t,e,r,i,s,o,a,u,l,c;for(l=[],r=0,s=n.length;r<s;r++){for(i in e={},t=!1,u=(a=n[r]).state)u[i],"step_"===i.slice(0,5)&&(o=i.slice(5),c=this.step[o],a.state[i]<c&&(e[i]=c,t=!0));t?l.push(a.setState(e)):l.push(void 0)}return l},1)},g=function(t){var e,r,n;for(e in r=[],t)switch(n=t[e],!1){case null==f[e]:e=c[e].base,r.push(p[e].merge(n));break;case null==p[e]:r.push(p[e].append(n));break;default:r.push(void 0)}return r},t.exports={Set:p,Map:u,Name:c,State:d,Finder:o,Query:f,PureObject:h,merge:g,step:_}},function(t,e,r){"use strict";var n,i,s,o,a,u=[].splice;i=r(0),a=function(t){return t?Array.isArray(t)?Array:t.constructor:t},o=function(t){var e,r,n;for(n={},Reflect.setPrototypeOf(n,null),e=0,r=t.length;e<r;e++)n[t[e]]=!0;return n},s=function(t,e,r){return e?new n(t,function(){var n,s,o;switch(this._filters=t._filters.concat(),a(e)){case Object:for(n in s=[],e)o=e[n],s.push(r(this,n,o,i.property(n)));return s;case Function:case Array:case String:return r(this,null,e,function(t){return t});default:return console.log({req:e})}}):t},t.exports=n=function(){class t{static build({$sort:e,$memory:r}){var n;return n=null,new t({_all_ids:n,_group:null,_filters:[],$sort:e,$partition:["set"]},function(){return this.all=this,this.$memory=r})}constructor(t,e){this._step=0,this._copy(t),e.call(this)}_copy({all:t,_all_ids:e,_group:r,_filters:n,$sort:i,$partition:s,$page_by:o}){this.all=t,this._all_ids=e,this._group=r,this._filters=n,this.$sort=i,this.$partition=s,this.$page_by=o}in(t){return s(this,t,function(t,e,r,n){var i,s;switch(i=function(e){return t._filters.push(e)},a(r)){case Array:return s=o(r),i(function(t){var e,r,i,o;for(e=0,i=(o=n(t)).length;e<i;e++)if(r=o[e],s[r])return!0;return!1});case RegExp:return i(function(t){var e,i,s,o;for(e=0,i=(s=n(t)).length;e<i;e++)if(o=s[e],r.test(o))return!0;return!1});case null:case 0:case"":case Boolean:case String:case Number:return i(function(t){var e;return-1<(null!=(e=n(t))?e.indexOf(r):void 0)});case void 0:break;default:throw console.log({target:e,req:[r,null!=r?r.constructor:void 0]}),Error("unimplemented")}})}partition(...e){return new t(this,function(){return this.$partition=e})}where(t){return s(this,t,function(t,e,r,n){var i,s;switch(i=function(e){return t._filters.push(e)},a(r)){case Function:return i(r);case Array:return"_id"===e?t._all_ids=r:(s=o(r),i(function(t){return s[n(t)]}));case RegExp:return i(function(t){return r.test(n(t))});case null:case 0:case"":case Boolean:case String:case Number:return"_id"===e?t._all_ids=[r]:i(function(t){return r===n(t)});case void 0:break;default:throw console.log({target:e,req:[r,null!=r?r.constructor:void 0]}),Error("unimplemented")}})}distance(t,e,r){return this.order("list",{sort:[e=>{var n,s,o,a,u,l;for(a=0,s=n=0,o=r.length;n<o;s=++n)l=r[s],u=i.get(e,t)[s],a+=Math.pow(u-l,2);return Math.pow(a,.5)},e]})}search(t){var e,r,n;return t&&(r=function(){var r,n,i,s;for(s=[],r=0,n=(i=t.split(/\s+/)).length;r<n;r++)(e=(e=i[r]).replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).length&&s.push(`(${e})`);return s}()).length?(n=new RegExp(r.join("|"),"ig"),this.where(function(t){var e;return!(e=t.q.search_words)||n.test(e)})):this}shuffle(){return this.sort(Math.random)}order(...e){var r,n,s;return s=e,[...e]=s,[r]=u.call(e,-1),e.length||e.push("list"),n=["_reduce",...e].join("."),i.isEqual(r,this.$sort[n])?this:new t(this,function(){return this.$sort=i.cloneDeep(this.$sort),this.$sort[n]=r})}sort(...t){return this.order({sort:t})}page(e){return new t(this,function(){return this.$page_by=e})}form(...t){var e,r,n;return(n=this.find(...t))?(r=null!=(e=this.all.$memory[n.id]).form?e.form:e.form={},Reflect.setPrototypeOf(r,n),r):n}find(...t){var e,r,n,i;for(e=0,n=t.length;e<n;e++)if(r=t[e],i=this.hash[r])return i;return null}finds(t){var e,r,n,i,s;for(s=[],e=0,n=t.length;e<n;e++)r=t[e],(i=this.hash[r])&&s.push(i);return s}pluck(){return this.list.pluck(...arguments)}}return Object.defineProperties(t.prototype,{reduce:{get:function(){return this.all._finder.calculate(this,this.all.$memory),this._reduce}},list:{get:function(){return this.reduce.list}},hash:{get:function(){return this.reduce.hash}},memory:{get:function(){return this.all.$memory}},ids:{get:function(){return Object.keys(this.hash)}}}),t}.call(void 0)},function(t,e,r){"use strict";t.exports=class{static bless(t,e,r){return r.bless(t.item),t.meta=e}constructor(t,e){this.meta=t,this.item=e,this.$group=[]}toJSON(t){return{item:this.item,$group:this.$group}}}},function(t,e,r){"use strict";t.exports={Query:r(2),Set:r(7),Map:r(8),List:r(9),Model:r(10),Struct:r(11),Finder:r(12)}},function(t,e,r){"use strict";var n;t.exports=n=r(1),n.Rule=r(6),n.Base=r(4)},function(t,e,r){"use strict";var n,i,s,o,a,u,l,c,h,f,p,d=[].splice,m=[].indexOf;h=r(0),o=r(1),({Finder:n,Query:u,Model:a,Struct:c,List:i,Set:l,Map:s}=r(4)),p=function(t){var e,r,n;return t=h.snakeCase(t).replace(/s$/,""),(r=o.Name[t])?r:(e=`${t}s`,o.Name[e]=o.Name[t]=n=o.PureObject(),n.base=t,n.list=e,n.id=`${t}_id`,n.ids=`${t}_ids`,n.deploys=[],n.depends=[],n)},f=function(t,e,r){return Object.defineProperty(t.model.prototype,e,r)},t.exports=class{constructor(t,e){this.$name=p(t),this.state=o.State.base(this.$name.list),this.all=u.build(this.state),this.all.$sort["_reduce.list"]={},this.all._cache={},this.all._finder=new n(this.$name,this.state),this.depend_on(this.$name.list),this.model=class extends a{},this.list=class extends i{},this.set=class extends l{},this.map=class extends s{},e&&this.schema(e)}schema(t){return t.call(this),this.model.$name=this.list.$name=this.set.$name=this.map.$name=this.$name,this.all._finder.join(this),o.Set[this.$name.base]=new this.set(this),o.Query[this.$name.list]=this.all,o.Finder[this.$name.list]=this.all._finder,this}key_by(t){var e;return e=function(){switch(null!=t?t.constructor:void 0){case void 0:return function(){return this._id};case Function:return t;case String:case Array:return h.property(t);default:throw Error(`unimplemented ${t}`)}}(),f(this,"id",{enumerable:!0,get:e})}struct(...t){var e,r;return r=t,[...t]=r,[e]=d.call(t,-1),this.model=class extends c{},t.forEach((t,e)=>f(this,t,{enumerable:!0,get:function(){return this[e]}})),f(this,"id",{enumerable:!0,get:e})}deploy(t){return this.$name.deploys.push(t)}depend_on(t){return o.Name[t].depends.push(t)}scope_without_cache(t){var e,r,n,i;for(e in n=[],r=t(this.all))i=r[e],n.push(this.all[e]=i);return n}scope(t){var e,r,n,i;for(e in n=[],r=t(this.all))i=r[e],n.push(this.use_cache(e,i));return n}property(t,e){return Object.defineProperties(this[t].prototype,e)}default_scope(t){return this.all._copy(t(this.all)),o.State.base(this.$name.list).$sort=this.all.$sort}shuffle(){return this.default_scope(function(t){return t.shuffle()})}sort(...t){return this.default_scope(function(e){return e.sort(...t)})}order(...t){return this.default_scope(function(e){return e.order(...t)})}relation_to_one(t,e,r,n){return f(this,t,{enumerable:!0,get:function(){var t;return t=h.get(this,r),o.Query[e].find(t,n)}})}relation_to_many(t,e,r,n,i){var s;return s=this.all,this.use_cache(t,function(t){return o.Query[e][n]({[`${i}`]:t})}),f(this,t,{enumerable:!0,get:function(){return s[t](this[r])}})}relation_tree(t,e){var r;return r=this.all,this.use_cache(t,function(n,i){var s;return i?(s=r.where({[`${e}`]:n}),r[t](s.ids,i-1)):r.where({id:n})}),f(this,t,{enumerable:!0,value:function(e){return r[t]([this.id],e)}})}relation_graph(t,e){var r;return r=this.all,this.use_cache(t,function(n,i){var s,o,a,u,l,c,f,p,d;if(p=r.where({id:n}),i){for(a=[],o=0,c=(d=p.pluck(e)).length;o<c;o++)if(null!=(s=d[o]))for(u=0,f=s.length;u<f;u++)null!=(l=s[u])&&a.push(l);return r[t](h.uniq(a),i-1)}return p}),f(this,t,{enumerable:!0,value:function(e){return r[t]([this.id],e)}})}use_cache(t,e){switch(null!=e?e.constructor:void 0){case Function:return this.all[t]=(...r)=>{var n,i;return null!=(n=this.all._cache)[i=`${t}:${JSON.stringify(r)}`]?n[i]:n[i]=e(...r)};default:return this.all[t]=e}}path(...t){var e,r,n,i,s,o,a;for("*"===t.slice(-1)[0]&&(({base:r,list:o}=this.$name),this.belongs_to(r),this.has_many(o),t.pop()),n=0,s=t.length;n<s;n++)i=t[n],this.belongs_to(i);return this.deploy(function(e,n,s){var o,a,u,l;for(l=this.id.split("-"),this.idx=l.slice(-1)[0],o=a=0,u=t.length;a<u;o=++a)this[`${i=t[o]}_id`]=l.slice(0,+o+1||9e9).join("-");return r&&t.length+1<l.length&&(this[`${r}_id`]=l.slice(0,-1).join("-")),n("id_tree",{navi:l})}),({all:e}=this),a=t.slice(-1)[0]+"_id",f(this,"siblings",{get:function(){var t;return(t={})[a]=this[a],e.where(t)}})}belongs_to(t,e={}){var r,n,i,s;return i=p(t),({key:r=i.id,target:s=i.list,miss:n}=e),this.relation_to_one(i.base,s,r,n)}habtm(t,e={}){var r,n,i;return n=p(t),e.reverse?(({key:r=this.$name.ids,target:i=t}=e),this.relation_to_many(n.list,i,"id","in",r)):(({key:r=n.ids,target:i=n.list}=e),this.relation_to_many(n.list,i,r,"where","id"))}has_many(t,e={}){var r,n,i;return n=p(t),({key:r=this.$name.id,target:i=n.list}=e),this.relation_to_many(n.list,i,"id","where",r)}tree(t={}){var e;return e=this.$name.id,this.relation_tree("nodes",e),this.belongs_to(this.$name.base,t),Object.defineProperties(this.all,{leaf:{get:function(){var t;return t=h.uniq(this.pluck(e)),this.where(function(e){var r;return r=e.id,m.call(t,r)<0})}}})}graph(t={}){var e,r,n;if(({directed:r,cost:e}=t),n=this.$name.ids,this.relation_to_many(this.$name.list,this.$name.list,n,"where","id"),this.relation_graph("path",n),!r)return!0}}},function(t,e,r){"use strict";var n,i,s,o,a,u;r(0),({State:i,Set:n}=r(1)),r(2),o=function(t){return function(e,r){var n;return n=this.finder.data_set(t,e,r),this.clear_cache(n)}},u=function(t,e){var r;if(null!=e)return r=this.finder.data_set("update",t,e),this.clear_cache(r)},a=function(t){return function(e,r){if(null!=e)return t.call(this,[e],r)}},s=function(t=!0){var e,r,n,s;if(null!=t)for(e=0,r=(s=this.$name.depends).length;e<r;e++)n=s[e],i.notify(n)},t.exports=n=function(){class t{constructor({$name:t,all:e,model:r}){this.$name=t,this.all=e,this.model=r,this.finder=this.all._finder}find(...t){var e,r,n,s,o,a;for(o=i.meta(),n=i.journal(this.$name.list),e=0,s=t.length;e<s;e++)if(r=t[e],a=this.all.$memory[r])return a.meta=o,n.$memory[r]=a,this.clear_cache(!0),a.item;return null}}return t.prototype.set=o("reset"),t.prototype.reset=o("reset"),t.prototype.merge=o("merge"),t.prototype.add=a(o("merge")),t.prototype.append=a(o("merge")),t.prototype.reject=o("remove"),t.prototype.del=a(o("remove")),t.prototype.remove=a(o("remove")),t.prototype.updates=u,t.prototype.update=a(u),t.prototype.clear_cache=s,t.prototype.refresh=s,t.prototype.rehash=s,t}.call(void 0)},function(t,e,r){"use strict";var n,i,s,o,a;o=r(0),({State:s,Query:i}=r(1)),n=function(t,e){return Object.defineProperties(t,{_diff:{enumerable:!1,writable:!0,value:null},diff:{enumerable:!1,get:function(){var t,r,i,s,a;return this._diff?this._diff:(this._diff=function(){var n,u,l,c,h;for(h=[],i=n=0,c=this.length-2;0<=c?n<=c:n>=c;i=0<=c?++n:--n){for(t=this[i],r=this[i+1],a={},u=0,l=e.length;u<l;u++)s=e[u],o.set(a,s,o.get(r,s)-o.get(t,s));h.push(a)}return h}.call(this),n(this._diff,e))}}}),t},a=function(t){var e,r,n,i,s,o,u,l,c;for(n=!1,i=0,s=(l=Object.keys(t)).length;i<s;i++)if(e=t[c=l[i]])switch((r=Object.keys(e)).length){case 0:n=!0,t[c]=0;break;case 1:n=!0,u=e[o=r[0]],delete t[c],t[o]=u;break;default:a(e)}return n&&a(t),t},t.exports=class{static bless(t){return Reflect.setPrototypeOf(t,this.prototype),t}static init(t,e){if(e.id&&(t.id=e.id),e.list&&(t.list=[]),e.count&&(t.count=0),e.all&&(t.all=0),e.count&&null!=e.all&&(t.variance=[]),e.pow&&(t.pow=0),e.set&&(t.hash={}),e.navi)return t.navi={}}static reduce(t,e,r,n,i){var s,o,a,u,l,c,h,f;if(n){if(i.count&&(n.count+=i.count),i.all&&(n.all+=i.all),i.count&&null!=i.all&&n.variance.push(i.all),i.pow&&(n.pow*=i.pow),i.list&&n.list.push(r),i.set&&(n.hash[i.set]=r),i.max&&(i.max<=n.max||(n.max_is=r,n.max=i.max)),i.min&&(n.min<=i.min||(n.min_is=r,n.min=i.min)),i.navi){for(s=[],c=n.navi,f=[],a=0,l=(h=i.navi).length;a<l;a++)o=h[a],s.push(o),u=s.join("-"),c,f.push(c=c[u]||(c[u]={}));return f}}else console.error("not found $format",e,i,t,r)}static finish(t,e,r,n){var i,s,o,u,l;if(r){if(r.hash&&(r.set=Object.keys(r.hash)),r.count&&null!=r.pow&&(r.avg=Math.pow(r.pow,1/r.count)),r.count&&null!=r.all&&(r.avg=r.all*(1/r.count)),i=r.variance){for(l=0,o=0,u=i.length;o<u;o++)s=i[o],l+=Math.pow(s-r.avg,2);r.variance=l/(r.count-1),r.sd=Math.pow(r.variance,.5),r.standard=function(t){return(t-this.avg)/this.sd}}return null!=r.min&&null!=r.max&&(r.range=r.max-r.min,r.all&&(r.density=r.all/r.range)),r.navi?a(r.navi):void 0}console.error("not found $format",e,t,n)}static order(t,e,r,n,s,a){var u,l,c,h,f,p,d,m,y,g,_,v,$,b,w,j,x,O,k,P;if(j=r,s.belongs_to)if(j instanceof Array)for(y=0,v=j.length;y<v;y++)P=j[y],Reflect.setPrototypeOf(P,i[s.belongs_to].find(P.id));else for(p in j)P=j[p],Reflect.setPrototypeOf(P,i[s.belongs_to].find(p));else if(j.constructor===Object)for(p in j)(P=j[p]).id=p;if(s.sort&&(j=o.orderBy(j,...s.sort)),(k=s.quantile)&&(O=(j.length-1)/k,c=function(){var t,e,r;for(r=[],f=t=0,e=k;0<=e?t<=e:t>=e;f=0<=e?++t:--t)r.push(j[Math.floor(f*O)]);return r}(),j.quantile=c),s.pluck&&(j=function(){var t,e,r;for(r=[],t=0,e=j.length;t<e;t++)x=j[t],(P=o.get(x,s.pluck))&&r.push(P);return r}()),_=s.index){for(u in j){x=j[u],h=(m="number"==typeof o.get(x,_))?[]:{};break}for(u in j)x=j[u],(l=h[d=o.get(x,_)])||(h[d]=l=new a(t)),l.push(x);if(s.mode){if(b=null,w=[],m)for(d=g=0,$=h.length;g<$;d=++g)(l=h[d])&&w.length<l.length&&(b=d,w=l);else for(d in h)(l=h[d])&&w.length<l.length&&(b=d,w=l);w.is_mode=b}j=h}return j}static dash(t,e,r,i,s,o){var a,u;if(r instanceof Array)return u=r,(a=s.diff)&&(u=n(u,a)),u}static post_proc(t,e,r,n,i,s){var o,a,u,l,c,h,f,p,d,m,y,g,_;if(d=r,i.cover){for(_=[],a=[],c=0,f=(g=i.cover).length;c<f;c++)n[u=g[c]]?a.push(u):_.push(u);d.remain=_,d.cover=a}if(i.page&&(y=t.$page_by)){for((d=[]).all=r.length,l=h=0,p=r.length;h<p;l=++h)m=r[l],l%y||d.push(o=new s(t)),o.push(m);d.page_idx=function(t){var e,r,n;for(this,n=e=0,r=this.length;e<r;n=++e)if(this[n].includes(t))return n;return null}}return d}}},function(t,e,r){const n=r(0);r(1),r(2);t.exports=class extends Array{get first(){return this[0]}get last(){return this[this.length-1]}get head(){return this[0]}get tail(){return this[this.length-1]}get uniq(){return this.constructor.bless(n.uniq(this))}pluck(...t){let e;switch(t.length){case 0:e=function(){return null};break;case 1:e=n.property(t[0]);break;default:e=function(e){return n.at(e,...t)}}return this.constructor.bless(this.map(e))}static bless(t,e){return Reflect.setPrototypeOf(t,this.prototype),e&&e.where&&e.in&&(t.query=e),t}constructor(t){super(),t&&t.where&&t.in&&(this.query=t)}sort(...t){const e=n.orderBy(this,...t);return Reflect.setPrototypeOf(e,Reflect.getPrototypeOf(this)),e}group_by(t){const e=n.groupBy(this,t);for(const t in e){const r=e[t];Reflect.setPrototypeOf(r,Reflect.getPrototypeOf(this))}return e}page_by(t){let e=0;return Object.values(this.group_by(function(r){return Math.floor(e++/t)}))}where(t){return this.query.where(t)}in(t){return this.query.in(t)}}},function(t,e){const r=class extends Object{static bless(t){return Reflect.setPrototypeOf(t,this.prototype),t}static deploy(t){}static update(t,e){}static create(t){}static delete(t){}static map_partition(t,e){}static map_reduce(t,e){}static order(t,e){}};t.exports=r,Object.defineProperties(r.prototype,{id:{enumerable:!0,get:function(){return this._id}}})},function(t,e){const r=class extends Array{static bless(t){return Reflect.setPrototypeOf(t,this.prototype),t}static deploy(t){}static update(t,e){}static create(t){}static delete(t){}static map_partition(t,e){}static map_reduce(t,e){}static order(t,e){}};t.exports=r,Object.defineProperties(r.prototype,{id:{enumerable:!0,get:function(){return this[0]}}})},function(t,e,r){"use strict";var n,i,s,a,u,l,c,h,f,p,d,m=[].splice;c=r(0),({Finder:i,State:l,Query:u,Format:s,PureObject:a,step:p}=r(1)),n=r(3),f=function({from:t},e){var r,n,i;switch(null!=t?t.constructor:void 0){case Array:for(r=0,i=t.length;r<i;r++)e((n=t[r]).id||n)}},h=function({from:t},e){var r,n,i,s;switch(null!=t?t.constructor:void 0){case Array:for(r=0,s=t.length;r<s;r++)e(i=t[r]);break;case Object:for(n in t)(i=t[n])._id=n,e(i)}},d=function(t,e,r){var n,i;if(!t||!r)return!1;for(n=0,i=r.length;n<i;n++)if(!(0,r[n])(t,e))return!1;return!0},t.exports=i=class{constructor(t){this.$name=t,l.notify(this.$name.list)}join({all:t,map:e,list:r,model:n}){this.all=t,this.map=e,this.list=r,this.model=n}calculate(t,e){var r,n,i,s,o,a;if(t._step<l.step[this.$name.list]){if(r=l.base(this.$name.list),delete t._reduce,t._step=p(),n={map:this.map,query:t,memory:e,cache:c.cloneDeep(r.$format),paths:{_reduce:{list:[],hash:{}}}},t._all_ids)this.reduce(n,t._all_ids);else if(t===t.all)this.reduce(n,Object.keys(e));else for(i=0,s=(a=t.$partition).length;i<s;i++)o=a[i],this.reduce(n,c.get(t.all,`reduce.${o}`));this.finish(n)}}reduce({map:t,cache:e,paths:r,query:n,memory:i},s){var o,a,u,l,c,h,f,p,m,y;if(s){for(y=[],u=0,h=s.length;u<h;u++)l=s[u],(p=i[l])&&(({meta:f,item:c,$group:o}=p),d(c,f,n._filters)&&y.push(function(){var i,s,u;for(u=[],i=0,s=o.length;i<s;i++)[m,a]=o[i],p=r[m]=e[m],u.push(t.reduce(n,m,c,p,a));return u}()));return y}}finish({map:t,cache:e,paths:r,query:n}){var i,s,o,a,u,l,h,f,p;for(u in r)a=r[u],t.finish(n,u,a,this.list),c.set(n,u,a);for(u in f=[],l=n.$sort)i=l[u],(o=c.get(n,u))&&(p=t.order(n,u,o,o,i,this.list),s=t.dash(n,u,p,o,i,this.list),h=t.post_proc(n,u,s,o,i,this.list),this.list.bless(h,n),h.from=o,f.push(c.set(n,u,h)));return f}data_set(t,e,r){var n,i,s,o;return o=l.meta(),n=l.base(this.$name.list),s=l.journal(this.$name.list),({deploys:i}=this.$name),this[t]({base:n,journal:s,meta:o,model:this.model,all:this.all,deploys:i,from:e,parent:r})}data_emitter({base:t,journal:e},{item:r,$group:n}){var i,s;if(!t.$format)throw new Error("bad context.");return i=(...r)=>{var n,i,s;return s=r,[...r]=s,[n]=m.call(r,-1),i=["_reduce",...r].join("."),t.$sort[i]=n,e.$sort[i]=n},(s=(...r)=>{var i,o,a,u,l,c,h;return h=r,[...r]=h,[a]=m.call(r,-1),a=s.default(r,a),c=["_reduce",...r].join("."),n.push([c,a]),u=null!=(i=t.$format)[c]?i[c]:i[c]={},l=null!=(o=e.$format)[c]?o[c]:o[c]={},this.map.init(u,a),this.map.init(l,a)}).default=s.default_origin=function(t,e){var n;return t.length?e:(s.default=function(t,e){return e},n={set:r.id,list:!0},Object.assign(n,e))},{reduce:s,order:i}}data_init({model:t,parent:e,deploys:r},{item:n},{reduce:i,order:s}){var o,a,u,l;for(t.bless(n),e&&c.merge(n,e),t.deploy.call(n,t),l=[],a=0,u=r.length;a<u;a++)o=r[a],l.push(o.call(n,t,i,s));return l}data_entry({model:t},{item:e},{reduce:r,order:n}){return t.map_partition(e,r),t.map_reduce(e,r),r.default===r.default_origin&&r({}),t.order(e,n)}reset(t){var e,r,n,i;for(e in t.journal.$memory=a(),t.base.$memory=t.all.$memory=r=a(),this.merge(t),i=t.base.$memory)n=i[e],null==r[e]&&t.model.delete(n);return!0}merge(t){var e;return e=!1,h(t,r=>{var i,s,o,a;if(a=t.base.$memory[r.id],o=new n(t.meta,r),i=this.data_emitter(t,o),this.data_init(t,o,i),this.data_entry(t,o,i),!(s=r.id))throw new Error(`detect bad data: ${JSON.stringify(r)}`);return t.journal.$memory[s]=o,t.base.$memory[s]=o,null!=a?t.model.update(r,a.item):t.model.create(r),e=!0}),e}remove(t){var e;return e=!1,f(t,r=>{var n;if(null!=(n=t.base.$memory[r]))return t.model.delete(n.item),delete t.journal.$memory[r],delete t.base.$memory[r],e=!0}),e}update(t,e){var r;return r=!1,f(t,n=>{var i,s;if(s=t.base.$memory[n])return c.merge(s.item,e),s.$group=[],i=this.data_emitter(t,o),this.data_entry(t,s,i),t.model.update(s.item,s.item),r=!0}),r}}}])});
//# sourceMappingURL=index.min.js.map