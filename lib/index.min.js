!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Mem=e():t.Mem=e()}(global,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)r.d(i,s,function(e){return t[e]}.bind(null,s));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=5)}([function(t,e){t.exports=require("lodash")},function(t,e,r){"use strict";var i,s,n,o,a,l,u,h,c,f,p,d,m,y,_,g;m=r(0),n=r(3),p={},l={},h={},f={},o={},i=[],s=0,c=function(){return Object.create(null)},u=class{static bless(t){return Reflect.setPrototypeOf(t,this.prototype),null==t.pack&&(t.pack=c()),t}json(){return JSON.stringify(this,(t,e)=>{var r,i;return e&&e.meta&&e.item&&e.$group&&e.meta===this?(({item:i,$group:r}=e),{item:i,$group:r}):e})}},a=function(t={}){return u.bless(t),t},g=function(){return++s},d={transaction:function(t,e){var r;return this.$journal=r=a(e),t(e),this.$journal=a(),r},journal:(y=function(t){return function(e){var r,i;return(r=d[t].pack)[e]?r[e]:((i=r[e]=c()).$sort=c(),i.$memory=c(),i.$format=c(),i)}})("$journal"),base:y("$base"),meta:function(){return this.$journal},step:c(),$journal:a(),$base:a(),store:function(t){var e,r,i,s,a,l,u,h,c,f,p;if(!(null!=t?t.pack:void 0))return!1;for(h in p=t.pack)if(({$sort:i,$memory:r,$format:e}=p[h]),a=o[h]){for(u in({model:c}=a),s=this.base(h),l=this.journal(h),i)f=i[u],s.$sort[u]=f,l.$sort[u]=f;for(u in e)f=e[u],s.$format[u]=f,l.$format[u]=f;for(u in r)f=r[u],n.bless(f,t,c),s.$memory[u]=f,l.$memory[u]=f;a.clear_cache()}else console.error("not found Finder and Query",h,t.pack);return!0},mixin:{data:function(){return{$step:d.step}}},join:function({react:t}){t&&i.push(t)},bye:function({react:t}){t&&(i=i.filter(function(e){return e!==t}))},notify:function(t){if(this.step[t]=g(),i.length)return this.notify_for_react()},notify_for_react:m.debounce(function(){var t,e,r,s,n,o,a,l,u,h;for(u=[],r=0,n=i.length;r<n;r++){for(s in e={},t=!1,l=(a=i[r]).state)l[s],"step_"===s.slice(0,5)&&(o=s.slice(5),h=this.step[o],a.state[s]<h&&(e[s]=h,t=!0));t?u.push(a.setState(e)):u.push(void 0)}return u},1)},_=function(t){var e,r,i;for(e in r=[],t)switch(i=t[e],!1){case null==f[e]:e=h[e].base,r.push(p[e].merge(i));break;case null==p[e]:r.push(p[e].append(i));break;default:r.push(void 0)}return r},t.exports={Set:p,Map:l,Name:h,State:d,Finder:o,Query:f,PureObject:c,merge:_,step:g}},function(t,e,r){"use strict";var i,s,n,o,a=[].splice;s=r(0),o=function(t){var e,r,i;for(i={},Reflect.setPrototypeOf(i,null),e=0,r=t.length;e<r;e++)i[t[e]]=!0;return i},n=function(t,e,r){return e?new i(t,function(){var i,n,o;switch(this._filters=t._filters.concat(),e&&e.constructor){case Object:for(i in n=[],e)o=e[i],n.push(r(this,i,o,s.property(i)));return n;case Function:case Array:case String:return r(this,null,e,function(t){return t});default:return console.log({req:e})}}):t},t.exports=i=function(){class t{static build({$sort:e,$memory:r}){var i;return i=null,new t({_all_ids:i,_group:null,_filters:[],$sort:e,$partition:["set"]},function(){return this.all=this,this.$memory=r})}constructor(t,e){this._step=0,this._copy(t),e.call(this)}_copy({all:t,_all_ids:e,_group:r,_filters:i,$sort:s,$partition:n,$page_by:o}){this.all=t,this._all_ids=e,this._group=r,this._filters=i,this.$sort=s,this.$partition=n,this.$page_by=o}in(t){return n(this,t,function(t,e,r,i){var s,n,a;switch(s=function(e){return t._filters.push(e)},null!=(n=null!=r?r.constructor:void 0)?n:r){case Array:return a=o(r),s(function(t){var e,r,s,n;for(e=0,s=(n=i(t)).length;e<s;e++)if(r=n[e],a[r])return!0;return!1});case RegExp:return s(function(t){var e,s,n,o;for(e=0,s=(n=i(t)).length;e<s;e++)if(o=n[e],r.test(o))return!0;return!1});case null:case 0:case"":case Boolean:case String:case Number:return s(function(t){var e;return-1<(null!=(e=i(t))?e.indexOf(r):void 0)});default:throw console.log({target:e,req:[r,null!=r?r.constructor:void 0]}),Error("unimplemented")}})}partition(...e){return new t(this,function(){return this.$partition=e})}where(t){return n(this,t,function(t,e,r,i){var s,n,a;switch(s=function(e){return t._filters.push(e)},null!=(n=null!=r?r.constructor:void 0)?n:r){case Function:return s(r);case Array:return"_id"===e?t._all_ids=r:(a=o(r),s(function(t){return a[i(t)]}));case RegExp:return s(function(t){return r.test(i(t))});case null:case 0:case"":case Boolean:case String:case Number:return"_id"===e?t._all_ids=[r]:s(function(t){return r===i(t)});default:throw console.log({target:e,req:[r,null!=r?r.constructor:void 0]}),Error("unimplemented")}})}search(t){var e,r,i;return t&&(r=function(){var r,i,s,n;for(n=[],r=0,i=(s=t.split(/\s+/)).length;r<i;r++)(e=(e=s[r]).replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).length&&n.push(`(${e})`);return n}()).length?(i=new RegExp(r.join("|"),"ig"),this.where(function(t){var e;return!(e=t.q.search_words)||i.test(e)})):this}shuffle(){return this.sort(Math.random)}order(...e){var r,i,n;return n=e,[...e]=n,[r]=a.call(e,-1),e.length||e.push("list"),i=["_reduce",...e].join("."),s.isEqual(r,this.$sort[i])?this:new t(this,function(){return this.$sort=s.cloneDeep(this.$sort),this.$sort[i]=r})}sort(...t){return this.order({sort:t})}page(e){return new t(this,function(){return this.$page_by=e})}form(...t){var e,r,i;return(i=this.find(...t))?(r=null!=(e=this.all.$memory[i.id]).form?e.form:e.form={},Reflect.setPrototypeOf(r,i),r):i}find(...t){var e,r,i,s;for(e=0,i=t.length;e<i;e++)if(r=t[e],s=this.hash[r])return s;return null}finds(t){var e,r,i,s,n;for(n=[],e=0,i=t.length;e<i;e++)r=t[e],(s=this.hash[r])&&n.push(s);return n}pluck(){return this.list.pluck(...arguments)}}return Object.defineProperties(t.prototype,{reduce:{get:function(){return this.all._finder.calculate(this,this.all.$memory),this._reduce}},list:{get:function(){return this.reduce.list}},hash:{get:function(){return this.reduce.hash}},memory:{get:function(){return this.all.$memory}},ids:{get:function(){return Object.keys(this.hash)}}}),t}.call(void 0)},function(t,e,r){"use strict";t.exports=class{static bless(t,e,r){return r.bless(t.item),t.meta=e}constructor(t,e){this.meta=t,this.item=e,this.$group=[]}toJSON(t){return{item:this.item,$group:this.$group}}}},function(t,e,r){"use strict";t.exports={Query:r(2),Set:r(7),Map:r(8),List:r(9),Model:r(10),Finder:r(11)}},function(t,e,r){"use strict";var i;t.exports=i=r(1),i.Rule=r(6),i.Base=r(4)},function(t,e,r){"use strict";var i,s,n,o,a,l,u,h,c,f=[].indexOf;h=r(0),o=r(1),({Finder:i,Query:l,Model:a,List:s,Set:u,Map:n}=r(4)),c=function(t){var e,r,i;return t=h.snakeCase(t).replace(/s$/,""),(r=o.Name[t])?r:(e=`${t}s`,o.Name[e]=o.Name[t]=i=o.PureObject(),i.base=t,i.list=e,i.id=`${t}_id`,i.ids=`${t}_ids`,i.deploys=[],i.depends=[],i)},t.exports=class{constructor(t,e){this.$name=c(t),this.state=o.State.base(this.$name.list),this.model=a,this.list=s,this.set=u,this.map=n,this.all=l.build(this.state),this.all.$sort["_reduce.list"]={},this.all._cache={},this.all._finder=new i(this.$name,this.state),this.depend_on(this.$name.list),this.map_property={},({base:t}=this.$name),this.model_property={[this.$name.id]:{enumerable:!0,get:function(){return this._id}}},this.form_property={changes:{enumerable:!0,value:function(t){return h.isEqual(this[t],this.find[t])?null:this.$model[t]}},isChanged:{enumerable:!0,get:function(){var t,e,r,i;for(t=0,i=(r=Object.keys(this)).length;t<i;t++)if(e=r[t],!h.isEqual(this[e],this.$model[e]))return!0;return!1}}},this.list_property={},this.set_property={},e&&this.schema(e)}schema(t){return t.call(this),this.model===a&&(this.model=class extends this.model{}),Object.assign(this.model_property,this.model.prototype),Object.defineProperties(this.model.prototype,this.model_property),this.list===s&&(this.list=class extends this.list{}),Object.assign(this.list_property,this.list.prototype),Object.defineProperties(this.list.prototype,this.list_property),this.set===u&&(this.set=class extends this.set{}),Object.assign(this.set_property,this.set.prototype),Object.defineProperties(this.set.prototype,this.set_property),this.map===n&&(this.map=class extends this.map{}),Object.assign(this.map_property,this.map.prototype),Object.defineProperties(this.map.prototype,this.map_property),this.model.$name=this.list.$name=this.set.$name=this.map.$name=this.$name,this.all._finder.deploy(this),o.Set[this.$name.base]=new this.set(this),o.Query[this.$name.list]=this.all,o.Finder[this.$name.list]=this.all._finder,this}key_by(t){var e;return e=function(){switch(null!=t?t.constructor:void 0){case void 0:return function(){return this._id};case Function:return t;case String:case Array:return h.property(t);default:throw Error(`unimplemented ${t}`)}}(),this.model_property.id={enumerable:!0,get:e}}deploy(t){return this.$name.deploys.push(t)}depend_on(t){return o.Name[t].depends.push(t)}scope(t){var e,r,i,s;for(e in i=[],r=t(this.all))s=r[e],i.push(this.use_cache(e,s));return i}property(t,e){return Object.assign(this[`${t}_property`],e)}default_scope(t){return this.all._copy(t(this.all)),o.State.base(this.$name.list).$sort=this.all.$sort}shuffle(){return this.default_scope(function(t){return t.shuffle()})}sort(...t){return this.default_scope(function(e){return e.sort(...t)})}order(...t){return this.default_scope(function(e){return e.order(...t)})}relation_to_one(t,e,r,i){return this.model_property[t]={enumerable:!0,get:function(){var t;return t=h.get(this,r),o.Query[e].find(t,i)}}}relation_to_many(t,e,r,i,s){var n;return n=this.all,this.use_cache(t,function(t){return o.Query[e][i]({[`${s}`]:t})}),this.model_property[t]={enumerable:!0,get:function(){return n[t](this[r])}}}relation_tree(t,e){var r;return r=this.all,this.use_cache(t,function(i,s){var n;return s?(n=r.where({[`${e}`]:i}),r[t](n.ids,s-1)):r.where({id:i})}),this.model_property[t]={enumerable:!0,value:function(e){return r[t]([this.id],e)}}}relation_graph(t,e){var r;return r=this.all,this.use_cache(t,function(i,s){var n,o,a,l,u,c,f,p,d;if(p=r.where({id:i}),s){for(a=[],o=0,c=(d=p.pluck(e)).length;o<c;o++)if(null!=(n=d[o]))for(l=0,f=n.length;l<f;l++)null!=(u=n[l])&&a.push(u);return r[t](h.uniq(a),s-1)}return p}),this.model_property[t]={enumerable:!0,value:function(e){return r[t]([this.id],e)}}}use_cache(t,e){switch(null!=e?e.constructor:void 0){case Function:return this.all[t]=(...r)=>{var i,s;return null!=(i=this.all._cache)[s=`${t}:${JSON.stringify(r)}`]?i[s]:i[s]=e(...r)};default:return this.all[t]=e}}path(...t){var e,r,i,s,n;for(r=0,s=t.length;r<s;r++)i=t[r],this.belongs_to(i);return this.deploy(function(){var e,r,s,n,o;for(o=this.id.split("-"),this.idx=o[t.length],n=[],e=r=0,s=t.length;r<s;e=++r)i=t[e],n.push(this[`${i}_id`]=o.slice(0,+e+1||9e9).join("-"));return n}),({all:e}=this),n=t.slice(-1)[0]+"_id",this.model_property.siblings={get:function(){var t;return(t={})[n]=this[n],e.where(t)}}}belongs_to(t,e={}){var r,i,s,n;return s=c(t),({key:r=s.id,target:n=s.list,miss:i}=e),this.relation_to_one(s.base,n,r,i)}habtm(t,e={}){var r,i,s;return i=c(t),e.reverse?(({key:r=this.$name.ids,target:s=t}=e),this.relation_to_many(i.list,s,"id","in",r)):(({key:r=i.ids,target:s=i.list}=e),this.relation_to_many(i.list,s,r,"where","id"))}has_many(t,e={}){var r,i,s;return i=c(t),({key:r=this.$name.id,target:s=i.list}=e),this.relation_to_many(i.list,s,"id","where",r)}tree(t={}){var e;return e=this.$name.id,this.relation_tree("nodes",e),this.belongs_to(this.$name.base,t),Object.defineProperties(this.all,{leaf:{get:function(){var t;return t=h.uniq(this.pluck(e)),this.where(function(e){var r;return r=e.id,f.call(t,r)<0})}}})}graph(t={}){var e,r,i;if(({directed:r,cost:e}=t),i=this.$name.ids,this.relation_to_many(this.$name.list,this.$name.list,i,"where","id"),this.relation_graph("path",i),!r)return!0}}},function(t,e,r){"use strict";var i,s,n,o,a,l;r(0),({State:s,Set:i}=r(1)),r(2),o=function(t){return function(e,r){var i,n,o;return o=s.meta(),i=s.base(this.$name.list),n=s.journal(this.$name.list),this.all._finder[t](o,i,n,this.all,e,r)}},l=function(t,e){var r,i,n;if(n=s.meta(),r=s.base(this.$name.list),i=s.journal(this.$name.list),null!=e)return this.all._finder.update(n,r,i,this.all,t,e)},a=function(t){return function(e,r){if(null!=e)return t.call(this,[e],r)}},n=function(){return this.all._finder.clear_cach()},t.exports=i=function(){class t{constructor({all:t,model:e,$name:r}){this.all=t,this.model=e,this.$name=r}find(...t){var e,r,i,n,o,a;for(o=s.meta(),i=s.journal(this.$name.list),e=0,n=t.length;e<n;e++)if(r=t[e],a=this.all.$memory[r])return a.meta=o,i.$memory[r]=a,this.all._finder.clear_cache(),a.item;return null}}return t.prototype.set=o("reset"),t.prototype.reset=o("reset"),t.prototype.merge=o("merge"),t.prototype.add=a(o("merge")),t.prototype.append=a(o("merge")),t.prototype.reject=o("remove"),t.prototype.del=a(o("remove")),t.prototype.remove=a(o("remove")),t.prototype.updates=l,t.prototype.update=a(l),t.prototype.clear_cache=n,t.prototype.refresh=n,t.prototype.rehash=n,t}.call(void 0)},function(t,e,r){"use strict";var i,s,n,o,a,l=[].splice;a=r(0),({State:o,Query:n}=r(1)),s=r(3),i=function(t,e){return Object.defineProperties(t,{_diff:{enumerable:!1,writable:!0,value:null},diff:{enumerable:!1,get:function(){var t,r,s,n,o;return this._diff?this._diff:(this._diff=function(){var i,l,u,h,c;for(c=[],s=i=0,h=this.length-2;0<=h?i<=h:i>=h;s=0<=h?++i:--i){for(t=this[s],r=this[s+1],o={},l=0,u=e.length;l<u;l++)n=e[l],a.set(o,n,a.get(r,n)-a.get(t,n));c.push(o)}return c}.call(this),i(this._diff,e))}}}),t},t.exports=class{static bless(t){return Reflect.setPrototypeOf(t,this.prototype),t}static $deploy(t,e,r,i,n,o){var a;return a=new s(i,o),this.$deploy_reduce(t,o,e,n,a),this.$deploy_sort(t,o,r,n),a}static $deploy_reduce(t,e,r,i,s){var n,o,a;if(n=o=function(t,r){var i;return t.length?r:(n=function(t,e){return e},i={set:e.id,list:!0},Object.assign(i,r))},a=(t=>(...e)=>{var s,o,a,u,h,c;return c=e,[...e]=c,[o]=l.call(e,-1),o=n(e,o),h=["_reduce",...e].join("."),t.push([h,o]),a=null!=r[h]?r[h]:r[h]={},u=null!=(s=i.$format)[h]?s[h]:s[h]={},this.init(a,o),this.init(u,o)})(s.$group),t.map_partition(e,a),t.map_reduce(e,a),n===o)return a({})}static $deploy_sort(t,e,r,i){var s;return s=function(...t){var e,s,n;return n=t,[...t]=n,[e]=l.call(t,-1),s=["_reduce",...t].join("."),r[s]=e,i.$sort[s]=e},t.order(e,s)}static init(t,e){if(e.id&&(t.id=e.id),e.list&&(t.list=[]),e.count&&(t.count=0),e.all&&(t.all=0),e.set)return t.hash={}}static reduce(t,e,r,i,s){if(i)return s.count&&(i.count+=s.count),s.all&&(i.all+=s.all),s.pow&&(i.pow*=s.pow),s.list&&i.list.push(r),s.set&&(i.hash[s.set]=r),s.max&&(s.max<=i.max||(i.max_is=r,i.max=s.max)),!s.min||i.min<=s.min?void 0:(i.min_is=r,i.min=s.min);console.error("not found $format",e,s,t,r)}static finish(t,e,r,i){if(r)return r.hash&&(r.set=Object.keys(r.hash)),r.count&&null!=r.pow&&(r.avg=Math.pow(r.all,1/r.count)),r.count&&null!=r.all&&(r.avg=r.all*(1/r.count)),null!=r.min&&null!=r.max&&(r.range=r.max-r.min,r.all)?r.density=r.all/r.range:void 0;console.error("not found $format",e,t,i)}static order(t,e,r,i,s){var o,l,u,h,c,f,p,d,m,y,_,g,$,v,b,j,O,w,x;if(b=r,i.belongs_to)if(b instanceof Array)for(d=0,_=b.length;d<_;d++)x=b[d],Reflect.setPrototypeOf(x,n[i.belongs_to].find(x.id));else for(c in b)x=b[c],Reflect.setPrototypeOf(x,n[i.belongs_to].find(c));else if(b.constructor===Object)for(c in b)(x=b[c]).id=c;if(i.sort&&(b=a.orderBy(b,...i.sort)),(w=i.quantile)&&(O=(b.length-1)/w,u=function(){for(var t=[],e=0;0<=w?e<=w:e>=w;0<=w?e++:e--)t.push(e);return t}.apply(this).map(t=>b[Math.floor(t*O)]),b.quantile=u),i.pluck&&(b=function(){var t,e,r;for(r=[],t=0,e=b.length;t<e;t++)j=b[t],(x=a.get(j,i.pluck))&&r.push(x);return r}()),y=i.index){for(o in b){j=b[o],h=(p="number"==typeof a.get(j,y))?[]:{};break}for(o in b)j=b[o],(l=h[f=a.get(j,y)])||(h[f]=l=new s(t)),l.push(j);if(i.mode){if($=null,v=[],p)for(f=m=0,g=h.length;m<g;f=++m)(l=h[f])&&v.length<l.length&&($=f,v=l);else for(f in h)(l=h[f])&&v.length<l.length&&($=f,v=l);v.is_mode=$}b=h}return b}static dash(t,e,r,s,n){var o,a;if(r instanceof Array)return a=r,(o=s.diff)&&(a=i(a,o)),a}static post_proc(t,e,r,i,s){var n,o,a,l,u,h,c,f,p,d,m,y,_;if(p=r,i.cover){for(_=[],o=[],u=0,c=(y=i.cover).length;u<c;u++)r[a=y[u]]?o.push(a):_.push(a);p.remain=_,p.cover=o}if(i.page&&(m=t.$page_by)){for((p=[]).all=r.length,l=h=0,f=r.length;h<f;l=++h)d=r[l],l%m||p.push(n=new s(t)),n.push(d);p.page_idx=function(t){var e,r,i;for(this,i=e=0,r=this.length;e<r;i=++e)if(this[i].includes(t))return i;return null}}return p}}},function(t,e,r){const i=r(0);r(1),r(2);t.exports=class extends Array{get first(){return this[0]}get last(){return this[this.length-1]}get head(){return this[0]}get tail(){return this[this.length-1]}get uniq(){return this.constructor.bless(i.uniq(this))}pluck(...t){let e;switch(t.length){case 0:e=function(){return null};break;case 1:e=i.property(t[0]);break;default:e=function(e){return i.at(e,...t)}}return this.constructor.bless(this.map(e))}static bless(t,e){return Reflect.setPrototypeOf(t,this.prototype),e&&e.where&&e.in&&(t.query=e),t}constructor(t){super(),this.query=t}sort(...t){const e=i.orderBy(this,...t);return Reflect.setPrototypeOf(e,Reflect.getPrototypeOf(this)),e}group_by(t){const e=i.groupBy(this,t);for(const t in e){const r=e[t];Reflect.setPrototypeOf(r,Reflect.getPrototypeOf(this))}return e}page_by(t){let e=0;return Object.values(this.group_by(function(r){return Math.floor(e++/t)}))}where(t){return this.query.where(t)}in(t){return this.query.in(t)}}},function(t,e,r){const i=r(0);t.exports=class{get id(){return this._id}static bless(t){return Reflect.setPrototypeOf(t,this.prototype),t}static $deploy(t,e){this.bless(t),e&&i.merge(t,e);const r=this.$name.deploys;for(let e=0,i=r.length;e<i;e++){r[e].call(t,this)}if(!t.id)throw new Error(`detect bad data: ${JSON.stringify(t)}`)}static update(t,e){}static create(t){}static delete(t){}static map_partition(t,e){}static map_reduce(t,e){}static order(t,e){}}},function(t,e,r){"use strict";var i,s,n,o,a,l,u,h,c,f;l=r(0),({Finder:i,State:a,Query:o,Format:s,PureObject:n,step:c}=r(1)),h=function({list:t},e,r){var i,s,n;switch(null!=e?e.constructor:void 0){case Array:for(i=0,n=e.length;i<n;i++)r((s=e[i]).id||s)}},u=function({list:t},e,r){var i,s,n,o;switch(null!=e?e.constructor:void 0){case Array:for(i=0,o=e.length;i<o;i++)r(n=e[i]);break;case Object:for(s in e)(n=e[s])._id=s,r(n)}},f=function(t,e,r){var i,s;if(!t||!r)return!1;for(i=0,s=r.length;i<s;i++)if(!(0,r[i])(t,e))return!1;return!0},t.exports=i=class{constructor(t,{$format:e}){this.$name=t,this.$format=e,a.notify(this.$name.list)}deploy({set:t,map:e,list:r,model:i}){this.set=t,this.map=e,this.list=r,this.model=i}calculate(t,e){var r,i,s,n,o,u;if(t._step<a.step[this.$name.list]){if(delete t._reduce,t._step=c(),r=l.cloneDeep(this.$format),o={_reduce:{list:[],hash:{}}},t._all_ids)this.reduce(this.map,r,o,t,e,t._all_ids);else if(t===t.all)this.reduce(this.map,r,o,t,e,Object.keys(e));else for(i=0,s=(u=t.$partition).length;i<s;i++)n=u[i],this.reduce(this.map,r,o,t,e,l.get(t.all,`reduce.${n}`));this.finish(this.map,r,o,t)}}reduce(t,e,r,i,s,n){var o,a,l,u,h,c,p,d,m,y;if(n){for(y=[],l=0,c=n.length;l<c;l++)u=n[l],(d=s[u])&&(({meta:p,item:h,$group:o}=d),f(h,p,i._filters)&&y.push(function(){var s,n,l;for(l=[],s=0,n=o.length;s<n;s++)[m,a]=o[s],d=r[m]=e[m],l.push(t.reduce(i,m,h,d,a));return l}()));return y}}finish(t,e,r,i){var s,n,o,a,u,h,c,f,p;for(u in r)a=r[u],t.finish(i,u,a,this.list),l.set(i,u,a);for(u in f=[],h=i.$sort)s=h[u],(o=l.get(i,u))&&(p=t.order(i,u,o,s,this.list),n=t.dash(i,u,p,s,this.list),c=t.post_proc(i,u,n,s,this.list),this.list.bless(c,i),c.from=o,f.push(l.set(i,u,c)));return f}clear_cache(t=!0){var e,r,i,s;if(null!=t)for(e=0,r=(s=this.$name.depends).length;e<r;e++)i=s[e],a.notify(i)}reset(t,e,r,i,s,o){var a,l,u,h;for(a in r.$memory=n(),e.$memory=i.$memory=l=n(),this.merge(t,e,r,i,s,o),h=e.$memory)u=h[a],null==l[a]&&this.model.delete(u);return this.clear_cache(!0)}merge(t,e,r,i,s,n){var o;return o=!1,u(this.$name,s,s=>{var a,l;return l=e.$memory[s.id],this.model.$deploy(s,n),a=this.map.$deploy(this.model,this.$format,i.$sort,t,r,s),r.$memory[s.id]=a,e.$memory[s.id]=a,null!=l?this.model.update(s,l.item):this.model.create(s),o=!0}),this.clear_cache(o)}remove(t,e,r,i,s){var n;return n=!1,h(this.$name,s,t=>{var i;if(null!=(i=e.$memory[t]))return this.model.delete(i.item),delete r.$memory[t],delete e.$memory[t],n=!0}),this.clear_cache(n)}update(t,e,r,i,s,n){var o,a;return({$memory:o}=i),a=!1,h(this.$name,s,s=>{var o,u;if(u=e.$memory[s])return l.merge(u.item,n),o=this.map.$deploy(this.model,this.$format,i.$sort,t,r,u.item),r.$memory[s]=o,e.$memory[s]=o,this.model.update(u.item,u.item),a=!0}),this.clear_cache(a)}}}])});
//# sourceMappingURL=index.min.js.map