!function(t,e){for(var r in e)t[r]=e[r]}(this,function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=3)}([function(t,e){t.exports=require("lodash")},function(t,e){var r,n,i,s,o,l,u,a,h;o={},n={},i={},s={},r={},l={step:{}},h=function(t,e){return i[t].deploys.push(e)},a=function(t,e){return i[t].depends.push(e)},u=function(t){var e,r,n;for(e in r=[],t)switch(n=t[e],!1){case null==s[e]:e=i[e].base,r.push(o[e].merge(n));break;case null==o[e]:r.push(o[e].append(n));break;default:r.push(void 0)}return r},t.exports={Set:o,Map:n,Name:i,State:l,Finder:r,Query:s,set_deploy:h,set_depend:a,merge:u}},function(t,e,r){var n,i,s,o,l;s=r(0),n=function(){return new Object(null)},l=function(t){var e,r,i;for(i=n(),e=0,r=t.length;e<r;e++)i[t[e]]=!0;return i},o=function(t,e,r){return e?new i(t,function(){var n,i,o;switch(this._filters=t._filters.concat(),e&&e.constructor){case Object:for(n in i=[],e)o=e[n],i.push(r(this,n,o,s.property(n)));return i;case Function:case Array:case String:return r(this,null,e,function(t){return t});default:return console.log({req:e})}}):t},t.exports=i=function(){class t{static build(){var e;return e=null,new t({_all_ids:e,_group:null,_filters:[],$sort:{},$partition:["set"]},function(){return this.all=this,this._memory=n()})}constructor(t,e){this._step=0,this._copy(t),e.call(this)}_copy({all:t,_all_ids:e,_group:r,_filters:n,$sort:i,$partition:s,$page_by:o}){this.all=t,this._all_ids=e,this._group=r,this._filters=n,this.$sort=i,this.$partition=s,this.$page_by=o}in(t){return o(this,t,function(t,e,r,n){var i,s;switch(i=function(e){return t._filters.push(e)},r&&r.constructor){case Array:return s=l(r),i(function(t){var e,r,i,o;for(e=0,i=(o=n(t)).length;e<i;e++)if(r=o[e],s[r])return!0;return!1});case RegExp:return i(function(t){var e,i,s,o;for(e=0,i=(s=n(t)).length;e<i;e++)if(o=s[e],r.test(o))return!0;return!1});case null:case 0:case"":case Boolean:case String:case Number:return i(function(t){var e;return-1<(null!=(e=n(t))?e.indexOf(r):void 0)});default:throw console.log({target:e,req:r,path:n}),Error("unimplemented")}})}partition(...e){return new t(this,function(){return this.$partition=e})}where(t){return o(this,t,function(t,e,r,n){var i,s;switch(i=function(e){return t._filters.push(e)},r&&r.constructor){case Function:return i(r);case Array:return"_id"===e?t._all_ids=r:(s=l(r),i(function(t){return s[n(t)]}));case RegExp:return i(function(t){return r.test(n(t))});case null:case 0:case Boolean:case String:case Number:return"_id"===e?t._all_ids=[r]:i(function(t){return r===n(t)});default:throw console.log({target:e,req:r,path:n}),Error("unimplemented")}})}search(t){var e,r,n;return t&&(r=function(){var r,n,i,s;for(s=[],r=0,n=(i=t.split(/\s+/)).length;r<n;r++)(e=(e=i[r]).replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).length&&s.push(`(${e})`);return s}()).length?(n=new RegExp(r.join("|"),"ig"),this.where(function(t){var e;return!(e=t.q.search_words)||n.test(e)})):this}shuffle(){return this.sort(Math.random)}order(e){return s.isEqual(e,this.$sort["_reduce.list"])?this:new t(this,function(){return this.$sort=s.cloneDeep(this.$sort),this.$sort["_reduce.list"]=e})}sort(...t){return this.order({sort:t})}page(e){return new t(this,function(){return this.$page_by=e})}form(...t){var e,r,n;return(n=this.find(...t))?((r=null!=(e=this.all._memory[n.id]).form?e.form:e.form={}).__proto__=n,r):n}find(...t){var e,r,n,i;for(e=0,n=t.length;e<n;e++)if(r=t[e],(i=this.hash[r])&&i)return i;return null}finds(t){var e,r,n,i,s;for(s=[],e=0,n=t.length;e<n;e++)r=t[e],(i=this.hash[r])&&s.push(i);return s}pluck(){return this.list.pluck(...arguments)}}return Object.defineProperties(t.prototype,{reduce:{get:function(){return this.all._finder.calculate(this,this.all._memory),this._reduce}},list:{get:function(){return this.reduce.list}},hash:{get:function(){return this.reduce.hash}},memory:{get:function(){return this.all._memory}},ids:{get:function(){return Object.keys(this.hash)}}}),t}.call(this)},function(t,e,r){var n;t.exports=n=r(1),n.Rule=r(5),n.Base=r(4)},function(t,e,r){t.exports={Query:r(2),Set:r(6),Map:r(7),List:r(8),Model:r(9),Finder:r(10)}},function(t,e,r){var n,i,s,o,l,u,a,h,c,p=[].indexOf;h=r(0),o=r(1),({Finder:n,Query:u,Model:l,List:i,Set:a,Map:s}=r(4)),c=function(t){var e,r,n,i,s,l;return t=h.snakeCase(t).replace(/s$/,""),(l=o.Name[t])?l:(n=`${t}_id`,i=`${t}_ids`,s=`${t}s`,r=[],e=[],o.Name[s]=o.Name[t]={id:n,ids:i,list:s,base:t,deploys:r,depends:e})},t.exports=class{constructor(t,e){this.$name=c(t),this.model=l,this.list=i,this.set=a,this.map=s,this.all=u.build(),this.all.cache={},this.all._finder=new n(this.$name),this.depend_on(t),this.map_property={},({base:t}=this.$name),this.model_property={id:{enumerable:!0,get:function(){return this._id}},[`${this.$name.id}`]:{enumerable:!0,get:function(){return this._id}}},this.form_property={changes:{enumerable:!0,value:function(t){return h.isEqual(this[t],this.find[t])?null:this.$model[t]}},isChanged:{enumerable:!0,get:function(){var t,e,r,n;for(t=0,n=(r=Object.keys(this)).length;t<n;t++)if(e=r[t],!h.isEqual(this[e],this.$model[e]))return!0;return!1}}},this.list_property={first:{enumerable:!1,get:function(){return this[0]}},head:{enumerable:!1,get:function(){return this[0]}},tail:{enumerable:!1,get:function(){return this[this.length-1]}},last:{enumerable:!1,get:function(){return this[this.length-1]}},uniq:{enumerable:!1,get:function(){return this.constructor.bless(h.uniq(this))}},pluck:{enumerable:!1,value:function(...t){return e=function(){switch(t.length){case 0:return function(){return null};case 1:return h.property(t[0]);default:return function(e){return h.at(e,...t)}}}(),this.constructor.bless(this.map(e))}}},this.set_property={},e&&this.schema(e)}schema(t){var e,r;return t.call(this),this.model===l&&(this.model=class extends this.model{}),Object.defineProperties(this.model.prototype,this.model_property),this.list===i&&(this.list=class extends this.list{}),Object.defineProperties(this.list.prototype,this.list_property),this.set===a&&(this.set=class extends this.set{}),Object.defineProperties(this.set.prototype,this.set_property),this.map===s&&(this.map=class extends this.map{}),Object.defineProperties(this.map.prototype,this.map_property),this.model.$name=this.set.$name=this.map.$name=this.$name,o.Query[this.$name.list]=this.all,o.Set[this.$name.base]=e=new this.set,e.all=this.all,e.$name=this.$name,this.list.bless([],this.all),o.Finder[this.$name.base]=r=this.all._finder,r.set=this.set,r.map=this.map,r.list=this.list,r.model=this.model,r.format={},this}key_by(t){var e;return e=function(){switch(null!=t?t.constructor:void 0){case void 0:return function(t){return t};case Function:return t;case String:case Array:return h.property(t);default:throw Error(`unimplemented ${t}`)}}(),this.model_property.id={enumerable:!0,get:e}}deploy(t){return o.set_deploy(this.$name.base,t)}depend_on(t){var e;return({_finder:e}=this.all),o.set_depend(t,function(){return e.clear_cache()})}scope(t){var e,r,n,i;for(e in n=[],r=t(this.all))i=r[e],n.push(this.use_cache(e,i));return n}property(t,e){return Object.assign(this[`${t}_property`],e)}default_scope(t){return this.all._copy(t(this.all))}shuffle(){return this.default_scope(function(t){return t.shuffle()})}order(...t){return this.default_scope(function(e){return e.sort(...t)})}relation_to_one(t,e,r,n){return this.model_property[t]={enumerable:!0,get:function(){var t;return t=h.get(this,r),o.Query[e].find(t,n)}}}relation_to_many(t,e,r,n,i){var s;return s=this.all,this.use_cache(t,function(t){return o.Query[e][r]({[`${i}`]:t})}),this.model_property[t]={enumerable:!0,get:function(){return s[t](this[n])}}}relation_tree(t,e){var r;return r=this.all,this.use_cache(t,function(n,i){var s;return i?(s=r.where({[`${e}`]:n}),r[t](s.ids,i-1)):r.where({_id:n})}),this.model_property[t]={enumerable:!0,value:function(e){return r[t]([this._id],e)}}}relation_graph(t,e){var r;return r=this.all,this.use_cache(t,function(n,i){var s,o,l,u,a,c,p,f,d;if(f=r.where({_id:n}),i){for(s=[],l=0,c=(d=f.pluck(e)).length;l<c;l++)if(null!=(o=d[l]))for(u=0,p=o.length;u<p;u++)null!=(a=o[u])&&s.push(a);return r[t](h.uniq(s),i-1)}return f}),this.model_property[t]={enumerable:!0,value:function(e){return r[t]([this._id],e)}}}use_cache(t,e){switch(null!=e?e.constructor:void 0){case Function:return this.all[t]=((...r)=>{var n,i;return null!=(n=this.all.cache)[i=`${t}:${JSON.stringify(r)}`]?n[i]:n[i]=e(...r)});default:return this.all[t]=e}}path(...t){var e,r,n,i,s;for(r=0,i=t.length;r<i;r++)n=t[r],this.belongs_to(n);return this.deploy(function(){var e,r,i,s,o;for(o=this._id.split("-"),this.idx=o[t.length],s=[],e=r=0,i=t.length;r<i;e=++r)n=t[e],s.push(this[`${n}_id`]=o.slice(0,+e+1||9e9).join("-"));return s}),({all:e}=this),s=t.slice(-1)[0]+"_id",this.model_property.siblings={get:function(){var t;return(t={})[s]=this[s],e.where(t)}}}belongs_to(t,e={}){var r,n,i,s;return i=c(t),({key:r=i.id,target:s=i.list,miss:n}=e),this.relation_to_one(i.base,s,r,n)}habtm(t,e={}){var r,n,i;return n=c(t),e.reverse?(({key:r=this.$name.ids,target:i=t}=e),this.relation_to_many(n.list,i,"in","_id",r)):(({key:r=n.ids,target:i=n.list}=e),this.relation_to_many(n.list,i,"where",r,"_id"))}has_many(t,e={}){var r,n,i;return n=c(t),({key:r=this.$name.id,target:i=n.list}=e),this.relation_to_many(n.list,i,"where","_id",r)}tree(t={}){var e;return e=this.$name.id,this.relation_tree("nodes",e),this.belongs_to(this.$name.base,t),Object.defineProperties(this.all,{leaf:{get:function(){var t;return t=h.uniq(this.pluck(e)),this.where(function(e){var r;return r=e._id,p.call(t,r)<0})}}})}graph(t={}){var e,r,n;if(({directed:r,cost:e}=t),n=this.$name.ids,this.relation_to_many(this.$name.list,this.$name.list,"where",n,"_id"),this.relation_graph("path",n),!r)return!0}}},function(t,e,r){var n,i,s,o,l;r(0),r(3),r(2),l=function(t,e){return this.all._finder.reset(this.all,t,e)},s=function(t,e){return this.all._finder.merge(this.all,t,e)},o=function(t){return this.all._finder.remove(this.all,t)},i=function(t){return function(e,r){if(null!=e)return t.call(this,[e],r)}},n=function(){return this.all._finder.clear_cach(this.all)},t.exports=function(){class t{}return t.prototype.set=l,t.prototype.reset=l,t.prototype.merge=s,t.prototype.add=i(s),t.prototype.append=i(s),t.prototype.reject=o,t.prototype.del=i(o),t.prototype.remove=i(o),t.prototype.clear_cache=n,t.prototype.refresh=n,t.prototype.rehash=n,t}.call(this)},function(t,e,r){var n,i,s=[].splice;i=r(0),({Query:n}=r(1)),t.exports=class{static bless(t){return t.__proto__=this.prototype,t}static $deploy(t,e,r,n,i){var s;return s={item:n,$group:[]},t.$deploy(n,i),this.$deploy_reduce(t,n,e,s),this.$deploy_sort(t,n,r),s}static $deploy_reduce(t,e,r,n){var i;return(i=(t=>(...e)=>{var n,i,o,l;return l=e,[...e]=l,[n]=s.call(e,-1),o=["_reduce",...e].join("."),t.push([o,n]),i=null!=r[o]?r[o]:r[o]={},this.init(i,n)})(n.$group))({list:!0}),t.map_partition(e,i),t.map_reduce(e,i)}static $deploy_sort(t,e,r){var n;return(n=function(...t){var e,n,i;return i=t,[...t]=i,[e]=s.call(t,-1),n=["_reduce",...t].join("."),r.$sort[n]=e})("list",{}),t.order(e,n)}static init(t,e){if(e.id&&(t.id=e.id),e.list&&(t.list=[]),e.count&&(t.count=0),e.all&&(t.all=0),e.set)return t.hash={}}static order(t,e,r,s,o,l){var u,a,h,c,p,f,d,_,m,g,y,v,b,$,w,x,j,O,k;if(x=r,Object===r.constructor)if(s.belongs_to)for(f in r)(k=r[f]).__proto__=n[s.belongs_to].find(f);else for(f in r)(k=r[f]).id=f;else if(s.belongs_to)for(p=0,v=r.length;p<v;p++)(k=r[p]).__proto__=n[s.belongs_to].find(k.id);if(s.sort&&(x=i.orderBy(x,...s.sort)),s.pluck&&(x=function(){var t,e,r;for(r=[],t=0,e=x.length;t<e;t++)j=x[t],(k=i.get(j,s.pluck))&&r.push(k);return r}()),g=s.group_by)for(a in r=x,x=i.groupBy(x,function(t){return i.get(t,g)}))a&&l(a);if(s.page&&(O=t.$page_by)){for(r=x,(x=[]).all=r.length,d=_=0,b=r.length;_<b;d=++_)j=r[d],d%O||x.push(h=[]),h.push(j);for(x.page_idx=function(t){var e,r,n;for(this,n=e=0,r=this.length;e<r;n=++e)if((a=this[n]).includes(t))return n;return null},m=0,$=x.length;m<$;m++)(a=x[m])&&l(a)}if(g=s.index){for(u in c=[],x)j=x[u],null==c[d=i.get(j,g)]&&(c[d]=[]),c[d].push(j);for(y=0,w=(x=c).length;y<w;y++)(a=x[y])&&l(a)}return l(x),x}static finish(t,e,r,n){if(r.hash&&(r.set=Object.keys(r.hash)),r.count&&null!=r.pow&&(r.avg=r.all**(1/r.count)),r.count&&null!=r.all&&(r.avg=r.all*(1/r.count)),null!=r.min&&null!=r.max&&(r.range=r.max-r.min,r.all))return r.density=r.all/r.range}static reduce(t,e,r,n,i){if(i.count&&(n.count+=i.count),i.all&&(n.all+=i.all),i.pow&&(n.pow*=i.pow),i.list&&n.list.push(r),i.set&&(n.hash[i.set]=r),i.max&&(i.max<=n.max||(n.max_is=r,n.max=i.max)),i.min&&!(n.min<=i.min))return n.min_is=r,n.min=i.min}}},function(t,e,r){var n;n=r(0),r(1),r(2),t.exports=class extends Array{static bless(t,e){return t.__proto__=this.prototype,t.query=e,t}sort(...t){var e;return(e=n.orderBy(this,...t)).__proto__=this.__proto__,e}group_by(t){var e,r;for(e in r=n.groupBy(this,t))r[e].__proto__=this.__proto__;return r}page_by(t){var e;return e=0,Object.values(this.group_by(function(r){return Math.floor(e++/t)}))}where(t){return this.query.where(t)}in(t){return this.query.in(t)}}},function(t,e,r){r(0),t.exports=function(){class t{static bless(t){return t.__proto__=this.prototype,t}static $deploy(t,e){var r,n,i;for(this.bless(t),Object.assign(t,e),r=0,n=(i=this.$name.deploys).length;r<n;r++)i[r].call(t,this);if(!t.id)throw new Error(`detect bad data: ${JSON.stringify(t)}`)}static update(t,e){}static create(t){}static delete(t){}static map_partition(t,e){return e({set:t.id})}static map_reduce(t,e){}static order(t,e){}}return t.rowid=0,t.aggregate=[function(t,e){}],t}.call(this)},function(t,e,r){var n,i,s,o,l,u,a,h;u=r(0),({State:l,Query:o,Format:i}=r(1)),s=function(){return new Object(null)},a=function({depends:t},e,r){var n,i,s,o,l,u;for(n=0,l=t.length;n<l;n++)(0,t[n])();switch(null!=e?e.constructor:void 0){case Array:for(o=0,u=e.length;o<u;o++)r(s=e[o]);break;case Object:for(i in e)(s=e[i])._id=i,r(s)}},h=function(t,e){var r,n;if(!t||!e)return!1;for(r=0,n=e.length;r<n;r++)if(!(0,e[r])(t))return!1;return!0},n=0,t.exports=class{constructor(t){this.name=t,l.step[this.name.list]=++n}calculate(t,e){var r,i,s,o,a,h;if(t._step<l.step[this.name.list]){if(delete t._reduce,t._step=++n,r=u.cloneDeep(this.format),a={_reduce:{list:[],hash:{}}},t._all_ids)this.reduce(this.map,r,a,t,e,t._all_ids);else if(t===t.all)this.reduce(this.map,r,a,t,e,Object.keys(e));else for(i=0,s=(h=t.$partition).length;i<s;i++)o=h[i],this.reduce(this.map,r,a,t,e,u.get(t.all,`reduce.${o}`));this.finish_order(this.map,r,a,t)}}reduce(t,e,r,n,i,s){var o,l,u,a,c,p,f,d,_;if(s){for(_=[],u=0,p=s.length;u<p;u++)a=s[u],(f=i[a])&&(({item:c,$group:o}=f),h(c,n._filters)&&_.push(function(){var i,s,u;for(u=[],i=0,s=o.length;i<s;i++)[d,l]=o[i],f=r[d]=e[d],u.push(t.reduce(n,d,c,f,l));return u}()));return _}}finish_order(t,e,r,n){var i,s,o,l,a,h;for(l in r)o=r[l],t.finish(n,l,o,this.list),u.set(n,l,o);for(l in h=[],a=n.$sort)i=a[l],(o=s=u.get(n,l))&&((o=t.order(n,l,o,i,this.list,t=>this.list.bless(t,n))).from=s,h.push(u.set(n,l,o)));return h}clear_cache(t=null){var e,r,i;if(l.step[this.name.list]=++n,t)for(e in i=t._memory)({item:r}=i[e]),this.map.$deploy_sort(this.model,r,t)}remove(t,e){var r,n;if(({_memory:r}=t),n=!1,a(this.name,e,t=>{var e;if(this.model.bless(t),null!=(e=r[t.id]))return this.model.delete(e.item),delete r[t.id],n=!0}),null!=n)return this.clear_cache()}reset(t,e,r){var n,i,o,l,u;for(i in({_memory:n}=t),t._memory=o=s(),this.merge(t,e,r),u=[],n)l=n[i],null==o[i]?u.push(this.model.delete(l)):u.push(void 0);return u}merge(t,e,r){var n;return({_memory:n}=t),a(this.name,e,e=>{var i,s;return i=this.map.$deploy(this.model,this.format,t,e,r),s=n[e.id],n[e.id]=i,null!=s?this.model.update(e,s.item):(this.model.create(e),this.model.rowid++)}),this.clear_cache()}}}]));
//# sourceMappingURL=index.min.js.map